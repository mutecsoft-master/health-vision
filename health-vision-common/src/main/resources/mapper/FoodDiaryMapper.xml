<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mutecsoft.healthvision.common.mapper.FoodDiaryMapper">

    <!--
        Food Diary 관련 공통 조회 컬럼
        TFD : TB_FOOD_DIARY 
    -->
    <sql id="foodDiaryColumn">
        TFD.FOOD_DIARY_ID
        , TFD.FOOD_NM
        , TFD.CALORIES
        , TFD.FOOD_FILE_ID
        , TFD.FOOD_DESC
        , TFD.MEAL_TYPE_CD
        , TFD.MEAL_DT
        , TFD.USER_ID
        , TFD.REG_ID
        , TFD.REG_DT
        , TFD.UPD_ID
        , TFD.UPD_DT
    </sql>
    
    <update id="updateFoodDiary" parameterType="com.mutecsoft.healthvision.common.model.FoodDiary">
        UPDATE TB_FOOD_DIARY
        SET FOOD_NM = #{foodNm}
            , CALORIES = #{calories}
            , FOOD_FILE_ID = #{foodFileId}
            , FOOD_DESC = #{foodDesc}
            , MEAL_TYPE_CD = #{mealTypeCd}
            , MEAL_DT = #{mealDt}
            , UPD_ID = #{updId}
            , UPD_DT = NOW()
        WHERE FOOD_DIARY_ID = #{foodDiaryId}
    </update>

    <insert id="insertFoodDiaryList" parameterType="com.mutecsoft.healthvision.common.model.FoodDiary">
        INSERT INTO TB_FOOD_DIARY(
            FOOD_NM
            , CALORIES
            , FOOD_FILE_ID
            , FOOD_DESC
            , MEAL_TYPE_CD
            , MEAL_DT
            , USER_ID
            , REG_ID
            , REG_DT
            , UPD_ID
            , UPD_DT
            
        )VALUES
        <foreach collection="foodDiaryList" item="item" separator=",">
        (
            #{item.foodNm}
            , #{item.calories}
            , #{item.foodFileId}
            , #{item.foodDesc}
            , #{item.mealTypeCd}
            , #{item.mealDt}
            , #{item.regId}
            , #{item.regId}
            , NOW()
            , #{item.updId}
            , NOW()
            
        )
        </foreach>
    </insert>
    
    <select id="selectFoodDiaryList" parameterType="com.mutecsoft.healthvision.common.dto.FoodDiaryDto$FoodDiarySearchRequest" resultType="com.mutecsoft.healthvision.common.model.FoodDiary">
        SELECT
            <include refid="foodDiaryColumn"/>
        FROM TB_FOOD_DIARY TFD
        WHERE 1=1
        AND TFD.USER_ID = #{userId}
        <if test='searchType == "DAILY"'>
            AND DATE(TFD.MEAL_DT) = DATE(#{date})
        </if>
        <if test='searchType == "WEEKLY"'>
            AND DATE(TFD.MEAL_DT) BETWEEN #{fromDate} AND #{toDate}
        </if>
        <if test='searchType == "MONTHLY"'>
            AND DATE_FORMAT(TFD.MEAL_DT, '%Y-%m') = #{yearMonth}
        </if>
        ORDER BY TFD.MEAL_DT DESC, TFD.FOOD_DIARY_ID ASC
    </select>
    
    <select id="selectFoodDiary" parameterType="com.mutecsoft.healthvision.common.dto.FoodDiaryDto$FoodDiarySearchRequest" resultType="com.mutecsoft.healthvision.common.model.FoodDiary">
        SELECT
            <include refid="foodDiaryColumn"/>
        FROM TB_FOOD_DIARY TFD
        WHERE TFD.FOOD_DIARY_ID = #{foodDiaryId}
        AND TFD.USER_ID = #{userId}
    </select>
    
    <delete id="deleteFoodDiary">
        DELETE 
        FROM TB_FOOD_DIARY
        WHERE FOOD_DIARY_ID = #{foodDiaryId}
    </delete>
    
    
    <select id="selectFoodDiaryListForHealthInfo" 
        parameterType="com.mutecsoft.healthvision.common.dto.HealthDto$HealthInfoRequest"
        resultType="com.mutecsoft.healthvision.common.model.FoodDiary">
        SELECT
            <include refid="foodDiaryColumn"/>
        FROM TB_FOOD_DIARY TFD
        WHERE TFD.USER_ID = #{userId}
        AND TFD.MEAL_TYPE_CD != 'S'
        <![CDATA[
        AND TFD.MEAL_DT >= STR_TO_DATE(#{startDate}, '%Y-%m-%d')
        AND TFD.MEAL_DT < DATE_ADD(STR_TO_DATE(#{endDate}, '%Y-%m-%d'), INTERVAL 1 DAY)
        ]]>
    </select>
    

</mapper>